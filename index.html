<!DOCTYPE html>
<html>
<head>
    <title>Salesperson Check-in</title>
</head>
<body>
    <h2>Check-in Form</h2>
    <form id="checkinForm">
        <label for="salesperson">Salesperson:</label>
        <select name="salesperson" id="salesperson"></select><br><br>

        <label for="zone">Zone:</label>
        <select name="zone" id="zone">
            <option value="">Select Zone</option>
            <option value="North">North</option>
            <option value="West">West</option>
            <option value="South">South</option>
        </select><br><br>

        <label for="customer">Customer:</label>
        <select name="customer" id="customer"></select><br><br>

        <label for="status">Status:</label>
        <select name="status" id="status">
            <option value="Visited">Visited</option>
            <option value="Visiting Today">Visiting Today</option>
        </select><br><br>

        <input type="hidden" name="latitude" id="latitude">
        <input type="hidden" name="longitude" id="longitude">

        <button type="submit">Check In</button>
    </form>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzxau3a3qX0jRav1wIwVm5Rj6OqpajxoZ61G_WuMbDlVDhVrLGRmRzMy3wHySKs6tKnnw/exec";

        // Load Salesperson list
        fetch('salespersons.json')
            .then(res => res.json())
            .then(data => {
                let spSelect = document.getElementById('salesperson');
                data.forEach(sp => {
                    let opt = document.createElement('option');
                    opt.value = sp.name;
                    opt.textContent = sp.name;
                    spSelect.appendChild(opt);
                });
            });

        // Load Customers CSV & filter by zone
        document.getElementById('zone').addEventListener('change', function () {
            let zone = this.value;
            fetch('customers.csv')
                .then(res => res.text())
                .then(text => {
                    let rows = text.split('\n').map(r => r.split(','));
                    let custSelect = document.getElementById('customer');
                    custSelect.innerHTML = '';
                    rows.forEach(r => {
                        if (r[1] && r[1].trim() === zone) {
                            let opt = document.createElement('option');
                            opt.value = r[0];
                            opt.textContent = r[0];
                            custSelect.appendChild(opt);
                        }
                    });
                });
        });

        // Capture location
        navigator.geolocation.getCurrentPosition(position => {
            document.getElementById('latitude').value = position.coords.latitude;
            document.getElementById('longitude').value = position.coords.longitude;
        });

        // Submit form
        document.getElementById('checkinForm').addEventListener('submit', function (e) {
            e.preventDefault();
            fetch(WEB_APP_URL, {
                method: 'POST',
                body: new FormData(this)
            })
            .then(res => res.text())
            .then(data => {
                alert("Check-in successful!");
                this.reset();
            })
            .catch(err => {
                console.error(err);
                alert("Error during check-in");
            });
        });
    </script>
</body>
</html>
