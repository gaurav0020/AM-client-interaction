<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Sales Check-In</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 500px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    select, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h2>Sales Check-In</h2>

  <form id="checkinForm">
    <label>Salesperson</label>
    <select id="salesperson" required>
      <option value="">-- Select Salesperson --</option>
    </select>

    <label>Zone</label>
    <select id="zone" required>
      <option value="">-- Select Zone --</option>
      <option value="North">North</option>
      <option value="West">West</option>
      <option value="South">South</option>
    </select>

    <label>Customer</label>
    <select id="customer" required>
      <option value="">-- Select Customer --</option>
    </select>

<!--     <label>Visit Type</label>
    <select id="visitType" required>
      <option value="">-- Select Visit Type --</option>
      <option value="Visit">Visit</option>
      <option value="Call">Call</option>
    </select> -->

    <label>Status</label>
    <select id="status" required>
      <option value="">-- Select Status --</option>
      <option value="Visiting today">Visiting today</option>
      <option value="Visited">Visited</option>
    </select>

    <button type="submit">Check In</button>
  </form>

  <script>
    const salesSelect = document.getElementById('salesperson');
    const zoneSelect = document.getElementById('zone');
    const customerSelect = document.getElementById('customer');
    let customersData = [];

    // Load salespersons from CSV
    fetch('./salespersons.csv')
      .then(r => {
        if (!r.ok) throw new Error('Failed to load salespersons.csv');
        return r.text();
      })
      .then(text => {
        const rows = text.replace(/\r/g, '').trim().split('\n');
        const headers = rows[0].split(',').map(h => h.trim().toLowerCase());
        const nameIndex = headers.indexOf('name');
        if (nameIndex === -1) throw new Error("CSV must have 'name' column");

        rows.slice(1).forEach(row => {
          const cols = row.split(',');
          const name = (cols[nameIndex] || '').trim();
          if (name) {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            salesSelect.appendChild(opt);
          }
        });
      })
      .catch(err => alert(err.message));

    // Load customers from CSV
    fetch('./customers.csv')
      .then(r => {
        if (!r.ok) throw new Error('Failed to load customers.csv');
        return r.text();
      })
      .then(text => {
        const rows = text.replace(/\r/g, '').trim().split('\n');
        const headers = rows[0].split(',').map(h => h.trim().toLowerCase());
        const nameIndex = headers.indexOf('customer');
        const zoneIndex = headers.indexOf('zone');
        if (nameIndex === -1 || zoneIndex === -1)
          throw new Error("CSV must have 'customer' and 'zone' columns");

        customersData = rows.slice(1).map(row => {
          const cols = row.split(',');
          return {
            name: (cols[nameIndex] || '').trim(),
            zone: (cols[zoneIndex] || '').trim()
          };
        });
      })
      .catch(err => alert(err.message));

    // Filter customers when zone changes
    zoneSelect.addEventListener('change', () => {
      customerSelect.innerHTML = '<option value="">-- Select Customer --</option>';
      const zone = zoneSelect.value;
      customersData
        .filter(c => c.zone.toLowerCase() === zone.toLowerCase())
        .forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.name;
          opt.textContent = c.name;
          customerSelect.appendChild(opt);
        });
    });

    // Handle form submission
    document.getElementById('checkinForm').addEventListener('submit', e => {
      e.preventDefault();

      if (!navigator.geolocation) {
        alert('Geolocation not supported by this browser');
        return;
      }

      navigator.geolocation.getCurrentPosition(pos => {
        const data = {
          timestamp: new Date().toISOString(),
          salesperson: salesSelect.value,
          zone: zoneSelect.value,
          customer: customerSelect.value,
          visitType: document.getElementById('visitType').value,
          status: document.getElementById('status').value,
          latitude: pos.coords.latitude,
          longitude: pos.coords.longitude
        };

        fetch('YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL', {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        }).then(() => {
          alert('Check-in submitted!');
          e.target.reset();
        }).catch(err => alert('Error submitting data: ' + err));
      });
    });
  </script>
</body>
</html>

